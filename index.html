<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü–æ—Ö–∏—â–µ–Ω–∏–µ –≤–æ —Å–Ω–µ</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
body {
    margin: 0;
    font-family: 'Press Start 2P', monospace;
    color: white;
    overflow: hidden;
    background: #000;
}

/* –°—Ü–µ–Ω–∞ */
#scene {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
}

/* –§–û–ù –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø */
.background-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    opacity: 0.9;
}

/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
.gif-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1;
}

/* –§–æ—Ç–æ */
#memoryPhoto {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 90%;
    max-height: 70%;
    border-radius: 15px;
    display: none;
    z-index: 2;
    border: 3px solid white;
    box-shadow: 0 0 20px rgba(255, 95, 125, 0.7);
    object-fit: contain;
}
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ */
.memory-gallery {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    width: 800px;
    max-width: 90%;
    z-index: 10;
    background: rgba(0, 0, 0, 0.85);
    padding: 30px;
    border-radius: 20px;
    border: 3px solid #ff5f7d;
    box-shadow: 0 0 40px rgba(255, 95, 125, 0.5);
}

.memory-photo {
    position: relative;
    width: 100%;
    height: 180px;
    overflow: hidden;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.4s ease;
    background: linear-gradient(145deg, #2a1a3a, #1a0a2a);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.memory-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all 0.5s ease;
    filter: blur(5px) grayscale(80%) brightness(0.8); /* –£–ú–ï–ù–¨–®–ï–ù–û –†–ê–ó–ú–´–¢–ò–ï */
}

.memory-photo:hover img {
    filter: blur(3px) grayscale(40%) brightness(1); /* –£–ú–ï–ù–¨–®–ï–ù–û –†–ê–ó–ú–´–¢–ò–ï –ü–†–ò –ù–ê–í–ï–î–ï–ù–ò–ò */
    transform: scale(1.05);
}

.memory-photo .photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    transition: all 0.4s ease;
    text-align: center;
    padding: 10px;
}

.memory-photo:hover .photo-overlay {
    background: rgba(255, 95, 125, 0.7);
    font-size: 16px;
    backdrop-filter: blur(5px);
}

/* –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ */
@keyframes memoryFlash {
    0% { 
        background: rgba(255, 255, 255, 0);
        transform: scale(1);
    }
    50% { 
        background: rgba(255, 255, 255, 0.8);
        transform: scale(1.02);
    }
    100% { 
        background: rgba(255, 255, 255, 0);
        transform: scale(1);
    }
}

.memory-flash {
    animation: memoryFlash 0.6s ease-out;
}

/* –¢–µ–∫—Å—Ç */
#text {
    font-family: 'Press Start 2P', monospace;
    font-size: 22px;
    line-height: 1.6;
    text-shadow: 2px 2px 4px #000;
    max-width: 90%;
    z-index: 3;
    position: relative;
    background: rgba(0, 0, 0, 0.4);
    padding: 20px;
    border-radius: 10px;
    margin: 10px;
}

/* –•–∞–± */
#hub {
    width: 100vw;
    height: 100vh;
    background: radial-gradient(circle, rgba(20,20,40,1) 0%, rgba(0,0,10,1) 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
}

/* –§–æ–Ω –¥–ª—è —Ö–∞–±–∞ */
.hub-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 0;
    opacity: 0.3;
}

/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ö–∞–±–∞ */
.hub-content {
    z-index: 2;
    position: relative;
    background: rgba(0, 0, 0, 0.7);
    padding: 40px;
    border-radius: 15px;
    border: 2px solid #ff5f7d;
    max-width: 90%;
    margin: 20px;
}

/* –ö–Ω–æ–ø–∫–∏ */
button {
    margin: 12px;
    padding: 15px 35px;
    font-size: 20px;
    font-weight: bold;
    border-radius: 12px;
    border: 2px solid #fff;
    background: linear-gradient(145deg, #ff5f7d, #ff9a9e);
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255,0,100,0.4);
    transition: 0.3s;
    font-family: 'Press Start 2P', monospace;
    z-index: 4;
    position: relative;
}
button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(255,0,100,0.6);
}

/* –ú–µ—Ä—Ü–∞—é—â–∏–π –ø–æ—Ä—Ç–∞–ª */
.portal {
    opacity: 0.3;
    pointer-events: none;
    animation: glow 1.5s infinite alternate;
}
.portal.visible {
    opacity: 1;
    pointer-events: auto;
}
@keyframes glow {
    0% { 
        box-shadow: 0 0 10px #ff5f7d;
        transform: scale(1);
    }
    100% { 
        box-shadow: 0 0 25px #ff9a9e, 0 0 40px #ff5f7d;
        transform: scale(1.05);
    }
}

/* –ö–Ω–æ–ø–∫–∞ –º—É–∑—ã–∫–∏ */
#musicBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    font-size: 14px;
    z-index: 1000;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ */
#choices {
    z-index: 3;
    position: relative;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90%;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ */
@keyframes pulse {
    0% { opacity: 0.8; }
    50% { opacity: 1; }
    100% { opacity: 0.8; }
}
.pulse-text {
    animation: pulse 2s infinite;
}

/* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
#loadingScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
    font-size: 24px;
    transition: opacity 0.5s;
}
.loader {
    width: 50px;
    height: 50px;
    border: 5px solid #ff5f7d;
    border-top: 5px solid transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 20px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –ú–∏–Ω–∏-–∏–≥—Ä—ã */
.mini-game {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 9999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.game-container {
    width: 800px;
    height: 600px;
    position: relative;
    border: 3px solid #ff5f7d;
    border-radius: 10px;
    overflow: hidden;
    background: #0a0a1a;
}
.game-info {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-size: 20px;
    z-index: 10;
}
#game1Canvas, #game2Canvas, #game3Canvas {
    width: 100%;
    height: 100%;
    display: block;
}
.game-controls {
    margin-top: 20px;
    text-align: center;
}
.instructions {
    color: #ff9a9e;
    font-size: 14px;
    margin: 10px 0;
}

/* –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ */
#finalKissScene {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.kiss-container {
    width: 800px;
    height: 600px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}
.kiss-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
}
.kiss-image {
    position: absolute;
    width: 500px;
    height: 333px;
    z-index: 2;
    transition: transform 0.5s;
}

/* –°—Ü–µ–Ω–∞ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è */
#wakeUpScene {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 10001;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.wakeup-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.8;
}
.wakeup-text {
    position: relative;
    z-index: 2;
    color: white;
    text-align: center;
    max-width: 80%;
    background: rgba(0, 0, 0, 0.6);
    padding: 30px;
    border-radius: 15px;
    border: 2px solid #ff5f7d;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes float {
    0%, 100% { transform: translateY(0px) scale(1); }
    50% { transform: translateY(-15px) scale(1.05); }
}
@keyframes scaleUp {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes heartBurst {
    0% { transform: scale(0.1); opacity: 1; }
    100% { transform: scale(4); opacity: 0; }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.float-animation {
    animation: float 3s ease-in-out infinite;
}
.scale-animation {
    animation: scaleUp 2s forwards;
}
.heart-burst {
    position: absolute;
    font-size: 50px;
    color: #ff5f7d;
    animation: heartBurst 2s ease-out;
    pointer-events: none;
    z-index: 3;
}
.fade-in {
    animation: fadeIn 2s forwards;
}

/* –≠—Ñ—Ñ–µ–∫—Ç —Å–∏—è–Ω–∏—è */
@keyframes glowEffect {
    0% { box-shadow: 0 0 10px #ff5f7d; }
    50% { box-shadow: 0 0 40px #ff5f7d, 0 0 80px #ff9a9e; }
    100% { box-shadow: 0 0 10px #ff5f7d; }
}
.glow-effect {
    animation: glowEffect 2s infinite;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    #text { font-size: 16px; padding: 15px; }
    button { padding: 12px 25px; font-size: 16px; margin: 8px; }
    .hub-content { padding: 20px; }
    #memoryPhoto { width: 80%; height: auto; }
    .game-container { width: 95vw; height: 60vh; }
    .kiss-container { width: 95vw; height: 60vh; }
    .kiss-image { width: 350px; height: 233px; }
}
@media (max-width: 480px) {
    #text { font-size: 14px; padding: 10px; }
    button { padding: 10px 20px; font-size: 14px; margin: 5px; }
    .hub-content h1 { font-size: 18px; }
    .hub-content p { font-size: 12px; }
    .kiss-image { width: 250px; height: 167px; }
}
</style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loadingScreen">
    <div class="loader"></div>
    <p id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏—Ä–æ–≤...</p>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ü–µ–Ω–∞ -->
<div id="scene" style="display:none;">
    <img id="backgroundImg" class="background-image" src="" alt="–§–æ–Ω">
    <div class="gif-overlay"></div>
    <div id="text"></div>
    <div id="choices"></div>
    <img id="memoryPhoto" src="">
</div>

<!-- –•–∞–± —Å –ø–æ—Ä—Ç–∞–ª–∞–º–∏ -->
<div id="hub" style="display:none;">
    <img id="hubBackground" class="hub-background" src="" alt="–§–æ–Ω —Ö–∞–±–∞">
    <div class="hub-content">
        <h1>–°–æ–Ω. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã‚Ä¶</h1>
        <p>–ù–∞–π–¥–∏ –∏—Ö, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –µ—ë.</p>
        <div id="portals"></div>
    </div>
</div>

<!-- –ú–∏–Ω–∏-–∏–≥—Ä—ã -->
<div id="miniGame1" class="mini-game">
    <div class="game-container">
        <canvas id="game1Canvas"></canvas>
        <div class="game-info">
            <div>‚ù§Ô∏è: <span id="heartsCount">0</span>/10</div>
            <div>üíÄ: <span id="livesCount">5</span></div>
            <div>–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speedCount">3</span></div>
        </div>
    </div>
    <div class="game-controls">
        <div class="instructions">–ü–†–û–ë–ï–õ - –ø—Ä—ã–∂–æ–∫ | –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ - –ü–†–û–ë–ï–õ –≤ –≤–æ–∑–¥—É—Ö–µ</div>
        <button onclick="endGame1()">–í—ã–π—Ç–∏</button>
    </div>
</div>

<div id="miniGame2" class="mini-game">
    <div class="game-container">
        <canvas id="game2Canvas"></canvas>
        <div class="game-info">
            <div>‚≠ê: <span id="starsCount">0</span>/10</div>
            <div>üíÄ: <span id="lives2Count">3</span></div>
            <div>–í—Ä–µ–º—è: <span id="timeCount">60</span>—Å</div>
        </div>
    </div>
    <div class="game-controls">
        <div class="instructions">WASD - –¥–≤–∏–∂–µ–Ω–∏–µ | –°–æ–±–µ—Ä–∏ 10 –∑–≤–µ–∑–¥ –∑–∞ 60 —Å–µ–∫—É–Ω–¥!</div>
        <button onclick="endGame2()">–í—ã–π—Ç–∏</button>
    </div>
</div>

<div id="miniGame3" class="mini-game">
    <div class="game-container">
        <canvas id="game3Canvas"></canvas>
        <div class="game-info">
            <div>‚ù§Ô∏è –ò–≥—Ä–æ–∫: <span id="playerHealth">150</span></div>
            <div>üíÄ –í—Ä–∞–≥: <span id="enemyHealth">200</span></div>
            <div>–ü–∞—Ç—Ä–æ–Ω—ã: <span id="ammoCount">30</span></div>
        </div>
    </div>
    <div class="game-controls">
        <div class="instructions">–ü–†–û–ë–ï–õ - —Å—Ç—Ä–µ–ª—å–±–∞ | WASD - –¥–≤–∏–∂–µ–Ω–∏–µ | R - –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ | E - —â–∏—Ç</div>
        <button onclick="endGame3()">–í—ã–π—Ç–∏</button>
    </div>
</div>

<!-- –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ —Å –ø–æ—Ü–µ–ª—É–µ–º -->
<div id="finalKissScene">
    <div class="kiss-container">
        <img class="kiss-background" src="images/kiss_bg.jpg" alt="–§–æ–Ω –ø–æ—Ü–µ–ª—É—è">
        <img id="kissImg" class="kiss-image" src="images/characters/kiss.png" alt="–ü–æ—Ü–µ–ª—É–π">
        <div id="kissText" style="position: absolute; bottom: 80px; z-index: 4; color: white; font-size: 28px; text-shadow: 2px 2px 4px #000;"></div>
    </div>
    <div class="game-controls">
        <button onclick="showWakeUpScene()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å...</button>
    </div>
</div>

<!-- –°—Ü–µ–Ω–∞ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è -->
<div id="wakeUpScene">
    <img class="wakeup-background" src="images/wakeup_bg.jpg" alt="–§–æ–Ω –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è">
    <div class="wakeup-text" id="wakeupText"></div>
    <div class="game-controls">
        <button onclick="restartGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
</div>

<!-- –ê—É–¥–∏–æ –∏ –∫–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
<audio id="bgMusic" loop></audio>
<button id="musicBtn" style="display:none;">üîä –í–∫–ª/–í—ã–∫–ª –º—É–∑—ã–∫—É</button>

<script>
// ===============================
// –≠–õ–ï–ú–ï–ù–¢–´ DOM
// ===============================
const scene = document.getElementById("scene");
const textDiv = document.getElementById("text");
const choicesDiv = document.getElementById("choices");
const hub = document.getElementById("hub");
const portalsDiv = document.getElementById("portals");
const music = document.getElementById("bgMusic");
const musicBtn = document.getElementById("musicBtn");
const memoryPhoto = document.getElementById("memoryPhoto");
const backgroundImg = document.getElementById("backgroundImg");
const hubBackground = document.getElementById("hubBackground");
const loadingScreen = document.getElementById("loadingScreen");
const loadingText = document.getElementById("loadingText");
const finalKissScene = document.getElementById("finalKissScene");
const kissImg = document.getElementById("kissImg");
const kissText = document.getElementById("kissText");
const wakeUpScene = document.getElementById("wakeUpScene");
const wakeupText = document.getElementById("wakeupText");

// ===============================
// –ù–ê–°–¢–†–û–ô–ö–ò –§–û–ù–û–í–´–• –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
// ===============================
const imageSettings = {
    start: { url: "images/backgrounds/start_bg.jpg", overlay: true },
    dream: { url: "images/backgrounds/dream_bg.jpg", overlay: true },
    rain: { url: "images/backgrounds/rain_bg.jpg", overlay: true },
    kiss: { url: "images/backgrounds/kiss_bg.jpg", overlay: true },
    hub: { url: "images/backgrounds/hub_bg.jpg", overlay: false },
    wakeup: { url: "images/backgrounds/wakeup_bg.jpg", overlay: true }
};

// ===============================
// –ù–ê–°–¢–†–û–ô–ö–ò –ú–£–ó–´–ö–ò
// ===============================
const musicFiles = {
    main: "audio/music.mp3",
    fight: "audio/fight.mp3",
};

// ===============================
// –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ï–ô
// ===============================
const characterImages = {
    player1: "images/characters/player1.png",
    player1Jump: "images/characters/player1_jump.png",
    player2: "images/characters/player2.png",
    enemy2: "images/characters/enemy2.png",
    player3: "images/characters/player3.png",
    enemy3: "images/characters/enemy3.png",
    kiss: "images/characters/kiss.png",
    heart: "images/items/heart.png",
    star: "images/items/star.png",
    bullet: "images/items/bullet.png",
    enemyBullet: "images/items/enemy_bullet.png"
};


// ===============================
// –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ===============================
let gameStarted = false;
let currentMemoryIndex = 0;

// ===============================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ===============================
function init() {
    music.volume = 0.4;
    musicBtn.onclick = () => {
        if (music.paused) {
            music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º—É–∑—ã–∫—É"));
        } else {
            music.pause();
        }
    };
    
    preloadCharacterImages();
}

// ===============================
// –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
// ===============================
function preloadCharacterImages() {
    const imagesToLoad = [
        ...Object.values(characterImages),
        ...Object.values(imageSettings).map(img => img.url)
    ];
    
    const totalImages = imagesToLoad.length;
    let loaded = 0;
    
    imagesToLoad.forEach(src => {
        const img = new Image();
        img.onload = () => {
            loaded++;
            loadingText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞... ${Math.round((loaded/totalImages)*100)}%`;
            
            if (loaded === totalImages) {
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        scene.style.display = 'flex';
                        musicBtn.style.display = 'block';
                        showStartScreen();
                    }, 500);
                }, 500);
            }
        };
        img.onerror = () => {
            console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${src}`);
            loaded++;
            
            if (loaded === totalImages) {
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        scene.style.display = 'flex';
                        musicBtn.style.display = 'block';
                        showStartScreen();
                    }, 500);
                }, 500);
            }
        };
        img.src = src;
    });
}
// ===============================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–£–ó–´–ö–û–ô
// ===============================
function playMusic(track) {
    if (music.src.includes(track) && !music.paused) {
        return; // –ú—É–∑—ã–∫–∞ —É–∂–µ –∏–≥—Ä–∞–µ—Ç
    }
    
    music.pause();
    music.src = track;
    music.currentTime = 0;
    
    const playPromise = music.play();
    
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            console.log("–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ú—É–∑—ã–∫–∞ –≤–∫–ª—é—á–∏—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏.");
            
            // –í–∫–ª—é—á–∞–µ–º –º—É–∑—ã–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
            const enableMusic = () => {
                music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É"));
                document.removeEventListener('click', enableMusic);
                document.removeEventListener('keydown', enableMusic);
                scene.removeEventListener('click', enableMusic);
            };
            
            document.addEventListener('click', enableMusic);
            document.addEventListener('keydown', enableMusic);
            scene.addEventListener('click', enableMusic);
        });
    }
}

// ===============================
// –§–û–ù
// ===============================
function setBackground(imgKey) {
    const settings = imageSettings[imgKey];
    if (!settings) return;
    
    backgroundImg.src = settings.url;
    backgroundImg.style.display = 'block';
    
    const overlay = document.querySelector('.gif-overlay');
    if (overlay) {
        overlay.style.display = settings.overlay ? 'block' : 'none';
    }
}

// ===============================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ===============================
function typeTextHTML(element, html, speed = 30, callback = null) {
    element.innerHTML = "";
    let tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    let nodes = Array.from(tempDiv.childNodes);
    
    let iNode = 0;
    
    function printNode() {
        if (iNode >= nodes.length) {
            if (callback) callback();
            return;
        }
        
        let node = nodes[iNode];
        iNode++;
        
        if (node.nodeType === 3) {
            let textContent = node.textContent;
            let j = 0;
            
            function printChar() {
                if (j < textContent.length) {
                    element.innerHTML += textContent[j];
                    j++;
                    setTimeout(printChar, speed);
                } else {
                    printNode();
                }
            }
            printChar();
        } else {
            let el = document.createElement(node.nodeName);
            element.appendChild(el);
            typeTextHTML(el, node.innerHTML, speed, printNode);
        }
    }
    printNode();
}

function nextButton(text, callback) {
    choicesDiv.innerHTML = "";
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.onclick = callback;
    choicesDiv.appendChild(btn);
}

// ===============================
// –ù–ê–ß–ê–õ–¨–ù–´–ô –≠–ö–†–ê–ù
// ===============================
function showStartScreen() {
    setBackground("start");
    typeTextHTML(textDiv, "<p class='pulse-text'>–ê –º–æ–∂–µ—Ç —ç—Ç–æ –≤—Å–µ —Å–æ–Ω?</p><p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å...</p>", 40, () => {
        nextButton("–ù–ê–ß–ê–¢–¨", startGameWithMusic);
        
        scene.style.cursor = "pointer";
        const startOnClick = (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.id !== 'musicBtn') {
                startGameWithMusic();
                scene.removeEventListener('click', startOnClick);
                scene.style.cursor = "default";
            }
        };
        scene.addEventListener('click', startOnClick);
    });
}

function startGameWithMusic() {
    if (gameStarted) return;
    gameStarted = true;
    
    music.src = musicFiles.main;
    music.play().catch(e => {
        console.log("–ú—É–∑—ã–∫–∞ –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è");
    });
    
    startPrologue();
}

// ===============================
// –ü–†–û–õ–û–ì –° –ì–ê–õ–ï–†–ï–ï–ô 6 –§–û–¢–û
// ===============================
function startPrologue() {
    setBackground("start");
    typeTextHTML(textDiv, "<p>–Ø –∑–∞—Å—ã–ø–∞–ª, –æ–±–Ω–∏–º–∞—è –ê–π–¥–∞–π‚Ä¶</p><p>–í—Å—ë –±—ã–ª–æ —Å–ø–æ–∫–æ–π–Ω–æ.</p>", 30, () => {
        nextButton("–£–°–ù–£–¢–¨", prologueStep1);
    });
}

function prologueStep1() {
    setBackground("dream");
    typeTextHTML(textDiv, 
        "<p>–ß—Ç–æ? –ü–æ—á–µ–º—É –û–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—Ç–≤–æ—Ä—è—Ç—å—Å—è‚Ä¶</p>" +
        "<p class='pulse-text'>–ì–æ–ª–æ—Å –∏–∑ —Ç–µ–º–Ω–æ—Ç—ã:</p>" +
        "<p>¬´–õ—é–±–æ–≤—å –∂–∏–≤—ë—Ç –≤ –ø–∞–º—è—Ç–∏. –ó–∞–±–µ—Ä–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî –∏ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç.¬ª</p>", 
        30, 
        () => {
            nextButton("–ü–†–û–°–ù–£–¢–¨–°–Ø", prologueStep2);
        }
    );
}

function prologueStep2() {
    setBackground("rain");
    
    // –°–æ–∑–¥–∞–µ–º –≥–∞–ª–µ—Ä–µ—é —Ñ–æ—Ç–æ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç—å—é
    const gallery = document.createElement('div');
    gallery.id = 'memoryGallery';
    gallery.className = 'memory-gallery';
    gallery.style.display = 'none';
    
    // –ú–∞—Å—Å–∏–≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ - –ú–û–ñ–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –õ–Æ–ë–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
    const memoryPhotos = [
        "images/memories/real1.jpg",
        "images/memories/real2.jpg", 
        "images/memories/real3.jpg",
        "images/memories/real4.jpg",
        "images/memories/real5.jpg",
        "images/memories/real6.jpg"
    ];
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
    const fallbackPhotos = [
        "https://images.unsplash.com/photo-1517841905240-472988babdf9?w=300&h=200&fit=crop",
        "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=300&h=200&fit=crop",
        "https://images.unsplash.com/photo-1517849845537-4d257902454a?w=300&h=200&fit=crop",
        "https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=300&h=200&fit=crop",
        "https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?w=300&h=200&fit=crop",
        "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=300&h=200&fit=crop"
    ];
    
    // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã
    for (let i = 0; i < 6; i++) {
        const photoContainer = document.createElement('div');
        photoContainer.className = 'memory-photo';
        
        const img = document.createElement('img');
        img.src = memoryPhotos[i];
        img.alt = `–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ ${i + 1}`;
        img.loading = 'lazy';
        
        // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        img.onerror = () => {
            console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ ${i + 1}, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback`);
            img.src = fallbackPhotos[i];
            
            // –ï—Å–ª–∏ –∏ fallback –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, —Å–æ–∑–¥–∞–µ–º —Ü–≤–µ—Ç–Ω—É—é –∑–∞–≥–ª—É—à–∫—É
            img.onerror = () => {
                createColorPlaceholder(img, i);
            };
        };
        
        const overlay = document.createElement('div');
        overlay.className = 'photo-overlay';
        overlay.innerHTML = `
            <div>
                <div style="font-size: 16px; margin-bottom: 5px;">–í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï ${i + 1}</div>
                <div style="font-size: 12px; color: #ff9a9e;">(–∫–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å)</div>
            </div>
        `;
        
        photoContainer.appendChild(img);
        photoContainer.appendChild(overlay);
        gallery.appendChild(photoContainer);
        
        // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø—ã—Ç–∞–µ–º—Å—è "–≤—Å–ø–æ–º–Ω–∏—Ç—å" - –¥–µ–ª–∞–µ–º —Ñ–æ—Ç–æ –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º
        photoContainer.onclick = () => {
            // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–µ–ª–∞–µ–º —Ñ–æ—Ç–æ –ø–æ—á—Ç–∏ —á–µ—Ç–∫–∏–º
            img.style.filter = 'blur(1px) grayscale(20%) brightness(1.1)';
            overlay.innerHTML = `
                <div class="pulse-text" style="color: #00ffaa; font-size: 16px;">
                     –í–°–ü–û–ú–ò–ù–ê–Æ... 
                </div>
            `;
            overlay.style.background = 'rgba(0, 150, 255, 0.6)';
            
            // –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏
            photoContainer.classList.add('memory-flash');
            
            // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            try {
                const clickSound = new Audio('audio/click.mp3');
                clickSound.volume = 0.3;
                clickSound.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫"));
            } catch (e) {
                console.log("–ó–≤—É–∫ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
            }
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ
            setTimeout(() => {
                img.style.filter = 'blur(5px) grayscale(80%) brightness(0.8)';
                overlay.innerHTML = `
                    <div style="color: #ffd700;">
                        <div style="font-size: 14px;">–ü–û–ß–¢–ò...</div>
                        <div style="font-size: 11px;">–Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è</div>
                    </div>
                `;
                overlay.style.background = 'rgba(255, 200, 0, 0.5)';
                photoContainer.classList.remove('memory-flash');
                
                // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                setTimeout(() => {
                    overlay.innerHTML = `
                        <div>
                            <div style="font-size: 16px; margin-bottom: 5px;">–í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï ${i + 1}</div>
                            <div style="font-size: 12px; color: #ff9a9e;">(–∫–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã –≤—Å–ø–æ–º–Ω–∏—Ç—å)</div>
                        </div>
                    `;
                    overlay.style.background = 'rgba(0, 0, 0, 0.7)';
                }, 2000);
            }, 3000);
        };
    }
    
    scene.appendChild(gallery);
    
    typeTextHTML(textDiv, 
        "<p class='pulse-text'>–Ø –ø—Ä–æ—Å–Ω—É–ª—Å—è</p>" +
        "<p>–ï—ë —Ä—è–¥–æ–º –Ω–µ—Ç.</p>" +
        "<p>–ù–∞ –º–æ—ë–º —Å—Ç–æ–ª–µ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ...</p>" +
        "<p style='color: #ff9a9e;'>–Ø –≤–∏–∂—É –Ω–∞—Å –≤–º–µ—Å—Ç–µ, –Ω–æ –ª–∏—Ü–∞ —Ä–∞–∑–º—ã—Ç—ã.</p>" +
        "<p>–ö—Ç–æ –æ–Ω–∞? –ü–æ—á–µ–º—É —è –Ω–µ –º–æ–≥—É –≤—Å–ø–æ–º–Ω–∏—Ç—å?</p>", 
        40, 
        () => {
            // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥–∞–ª–µ—Ä–µ–∏
            const viewBtn = document.createElement("button");
            viewBtn.innerText = "–Ø –ù–ï –ú–û–ì–£ –í–°–ü–û–ú–ù–ò–¢–¨...";
            viewBtn.className = "pulse-text";
            viewBtn.style.cssText = `
                background: linear-gradient(145deg, #6a11cb, #2575fc);
                font-size: 18px;
                padding: 20px 40px;
                margin: 20px;
            `;
            viewBtn.onclick = function() {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
                gallery.style.display = 'grid';
                textDiv.style.display = 'none';
                choicesDiv.innerHTML = '';
                
                // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                const instruction = document.createElement('div');
                instruction.innerHTML = `
                    <div style="
                        position: absolute;
                        top: 50px;
                        left: 50%;
                        transform: translateX(-50%);
                        color: white;
                        text-align: center;
                        background: rgba(0, 0, 0, 0.7);
                        padding: 15px;
                        border-radius: 10px;
                        border: 2px solid #ff5f7d;
                        z-index: 11;
                        max-width: 80%;
                    ">
                        <p style="margin: 0 0 10px 0; font-size: 18px; color: #ff9a9e;">
                            üí≠ –†–ê–ó–ú–´–¢–´–ï –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–Ø
                        </p>
                        <p style="margin: 0; font-size: 14px;">
                            –ö–ª–∏–∫–∞–π –Ω–∞ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤—Å–ø–æ–º–Ω–∏—Ç—å...
                        </p>
                    </div>
                `;
                scene.appendChild(instruction);
                
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–†–û–î–û–õ–ñ–ò–¢–¨"
                const continueBtn = document.createElement('button');
                continueBtn.textContent = '–ü–†–û–î–û–õ–ñ–ò–¢–¨...';
                continueBtn.style.cssText = `
                    position: absolute;
                    bottom: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 11;
                    padding: 15px 35px;
                    font-size: 18px;
                    background: linear-gradient(145deg, #ff5f7d, #ff9a9e);
                    border: 3px solid white;
                `;
                continueBtn.onclick = function() {
                    // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –∏ –∫–Ω–æ–ø–∫—É
                    gallery.remove();
                    continueBtn.remove();
                    instruction.remove();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
                    textDiv.style.display = 'block';
                    prologueStep3();
                };
                
                scene.appendChild(continueBtn);
                
                // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ 25 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (continueBtn.parentNode) {
                        continueBtn.click();
                    }
                }, 25000);
            };
            
            choicesDiv.innerHTML = '';
            choicesDiv.appendChild(viewBtn);
        }
    );
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ü–≤–µ—Ç–Ω—ã—Ö –∑–∞–≥–ª—É—à–µ–∫
function createColorPlaceholder(imgElement, index) {
    const colors = [
        ['#2a1a3a', '#ff5f7d'], // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π/—Ä–æ–∑–æ–≤—ã–π
        ['#1a2a3a', '#00b4d8'], // —Å–∏–Ω–∏–π/–≥–æ–ª—É–±–æ–π
        ['#1a3a2a', '#4cc9f0'], // –∑–µ–ª–µ–Ω—ã–π/–±–∏—Ä—é–∑–æ–≤—ã–π
        ['#3a2a1a', '#f72585'], // –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π/–ø—É—Ä–ø—É—Ä–Ω—ã–π
        ['#2a3a1a', '#7209b7'], // –æ–ª–∏–≤–∫–æ–≤—ã–π/—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        ['#3a1a2a', '#3a0ca3']  // –±–æ—Ä–¥–æ–≤—ã–π/—Å–∏–Ω–∏–π
    ];
    
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 200;
    const ctx = canvas.getContext('2d');
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
    const gradient = ctx.createLinearGradient(0, 0, 300, 200);
    gradient.addColorStop(0, colors[index][0]);
    gradient.addColorStop(1, colors[index][1]);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 300, 200);
    
    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–∑–º—ã—Ç—ã–π –∫—Ä—É–≥
    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.beginPath();
    ctx.arc(150, 100, 60, 0, Math.PI * 2);
    ctx.fill();
    
    // –¢–µ–∫—Å—Ç
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`–í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï`, 150, 80);
    ctx.fillText(`${index + 1}`, 150, 110);
    
    // –ü–æ–¥–ø–∏—Å—å
    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.font = '14px Arial';
    ctx.fillText('(–ª–∏—Ü–æ —Ä–∞–∑–º—ã—Ç–æ)', 150, 140);
    
    imgElement.src = canvas.toDataURL();
    imgElement.style.filter = 'blur(5px) grayscale(30%) brightness(0.9)';
}

function prologueStep3() {
    // –£–±–∏—Ä–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const gallery = document.getElementById('memoryGallery');
    if (gallery) {
        gallery.remove();
    }
    
    // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–†–û–î–û–õ–ñ–ò–¢–¨" –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const continueBtn = scene.querySelector('button[onclick*="prologueStep3"]');
    if (continueBtn) {
        continueBtn.remove();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏
    textDiv.style.display = 'block';
    textDiv.innerHTML = '';
    choicesDiv.innerHTML = '';
    
    setBackground("kiss");
    memoryPhoto.style.display = "none";
    
    typeTextHTML(textDiv, 
        "<p>–£ –º–µ–Ω—è –∫—Ç–æ-—Ç–æ –±—ã–ª‚Ä¶</p>" +
        "<p>–ö—Ç–æ-—Ç–æ —Ü–µ–Ω–Ω—ã–π –º–Ω–µ. –Ø —Ö–æ—á—É –≤—Å–ø–æ–º–Ω–∏—Ç—å, —è —Ö–æ—á—É –≤–µ—Ä–Ω—É—Ç—å.</p>", 
        30, 
        () => {
            nextButton("–ó–ê–ö–†–´–¢–¨ –ì–õ–ê–ó–ê", showHub);
        }
    );
}

// ===============================
// –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–Ø
// ===============================
const memories = [
    {
        title: "–ü–û–î –î–£–ë–û–ú",
        text: "–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ, —à–µ–ª –¥–æ–∂–¥–∏–∫, –º—ã —Å–∏–¥–µ–ª–∏ –ø–æ–¥ –¥—É–±–æ–º –∏ –¥–æ–ª–≥–æ –¥–æ–ª–≥–æ –±–æ–ª—Ç–∞–ª–∏...",
        collected: false,
        bg: "rain",
        game: startMiniGame1
    },
    {
        title: "–ü–ï–†–í–´–ô –ü–û–¶–ï–õ–£–ô",
        text: "–ü–æ—Å–ª–µ –±–∞—Ä–∞ –º—ã —Å –Ω–µ–π –ø–æ—Ü–µ–ª–æ–≤–∞–ª–∏—Å—å. –í–∫—É—Å –∞–ª–∫–æ–≥–æ–ª—è –Ω–∞ –µ—ë –≥—É–±–∞—Ö, —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ, —É—Å–∫–æ—Ä—è—é—â–µ–µ—Å—è —Å –∫–∞–∂–¥–æ–π —Å–µ–∫—É–Ω–¥–æ–π...",
        collected: false,
        bg: "kiss",
        game: startMiniGame2
    },
    {
        title: "–¢–û–¢ –°–ê–ú–´–ô –î–ï–ù–¨",
        text: "–ö–∞–∫ –º—ã –Ω–∞—á–∞–ª–∏ –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è... –º—ã –±—ã–ª–∏ –≤ –∫–∞—Ñ–µ, –∞ –∑–∞—Ç–µ–º —è –∫—É–ø–∏–ª –µ–π –º–∏—à–∫—É...",
        collected: false,
        bg: "dream",
        game: startMiniGame3
    }
];

// ===============================
// –•–ê–ë –° –ü–û–†–¢–ê–õ–ê–ú–ò
// ===============================
function showHub() {
    scene.style.display = "none";
    hub.style.display = "flex";
    hubBackground.src = imageSettings.hub.url;
    portalsDiv.innerHTML = "";
    
    memories.forEach((mem, idx) => {
        const btn = document.createElement("button");
        btn.innerText = mem.title;
        btn.classList.add("portal");
        
        // –ü–æ—Ä—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏:
        const isAvailable = idx === 0 || mem.collected || 
                           (idx > 0 && memories[idx-1].collected);
        
        if (isAvailable) {
            btn.classList.add("visible");
        }
        
        if (mem.collected) {
            btn.style.opacity = "0.7";
            btn.style.background = "linear-gradient(145deg, #4CAF50, #45a049)";
            btn.innerHTML = `‚úÖ ${mem.title}`;
        } else {
            btn.style.background = "linear-gradient(145deg, #ff5f7d, #ff9a9e)";
        }
        
        btn.onclick = () => openMemory(idx);
        portalsDiv.appendChild(btn);
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ–±—Ä–∞–Ω—ã
    const allCollected = memories.every(m => m.collected);
    if (allCollected) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ü–µ–Ω—ã
        const finalBtn = document.createElement("button");
        finalBtn.innerHTML = "üíñ –í–ï–†–ù–£–¢–¨ –ï–Å üíñ";
        finalBtn.style.background = "linear-gradient(145deg, #ffd700, #ff6b6b)";
        finalBtn.style.fontSize = "24px";
        finalBtn.style.padding = "20px 40px";
        finalBtn.classList.add("visible", "pulse-text");
        finalBtn.onclick = showFinalKissScene;
        portalsDiv.appendChild(finalBtn);
    }
}

function openMemory(idx) {
    const mem = memories[idx];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞–ª–∞
    if (idx > 0 && !memories[idx-1].collected && !mem.collected) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        hub.style.display = "none";
        scene.style.display = "flex";
        setBackground("dream");
        typeTextHTML(textDiv, 
            `<p>–≠—Ç–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –µ—â—ë –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ...</p>
            <p>–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</p>
            <p class="pulse-text">${memories[idx-1].title}</p>`, 
            30, 
            () => {
                nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
            }
        );
        return;
    }
    
    currentMemoryIndex = idx;
    
    hub.style.display = "none";
    scene.style.display = "flex";
    setBackground(mem.bg);
    memoryPhoto.style.display = "none";
    
    if (mem.collected) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        typeTextHTML(textDiv, 
            `<p class="pulse-text">‚úÖ –≠–¢–û –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï –£–ñ–ï –°–û–ë–†–ê–ù–û</p>
            <p>${mem.text}</p>`, 
            30, 
            () => {
                nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
            }
        );
    } else {
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
        typeTextHTML(textDiv, mem.text, 30, () => {
            nextButton("–ü–û–ì–†–£–ó–ò–¢–¨–°–Ø –í –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï", () => {
                mem.game();
            });
        });
    }
}

// ===============================
// –ú–ò–ù–ò-–ò–ì–†–ê 1: –ë–ï–ì–£–ù –°–û –°–ï–†–î–ï–ß–ö–ê–ú–ò
// ===============================
function startMiniGame1() {
    console.log("–ó–∞–ø—É—Å–∫ –º–∏–Ω–∏-–∏–≥—Ä—ã 1...");
    
    scene.style.display = "none";
    document.getElementById("miniGame1").style.display = "flex";
    
    const canvas = document.getElementById("game1Canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 500;
    
    // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
    document.getElementById("heartsCount").textContent = "0";
    document.getElementById("livesCount").textContent = "5";
    document.getElementById("speedCount").textContent = "3";
    
    let score = 0;
    let lives = 5;
    let gameOver = false;
    let frame = 0;
    let gameSpeed = 3;
    
    // –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô
    const playerImg = new Image();
    playerImg.src = characterImages.player1;
    
    const playerJumpImg = new Image();
    playerJumpImg.src = characterImages.player1Jump;
    
    const heartImg = new Image();
    heartImg.src = characterImages.heart;
    
    const enemyImg = new Image();
    enemyImg.src = characterImages.enemy2;
    
    // –ü—Ä–æ—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –æ–±—ä–µ–∫—Ç–æ–≤
    const hearts = [];
    const enemies = [];
    
    // –ò–≥—Ä–æ–∫
    const player = {
        x: 100,
        y: 350,
        width: 80,
        height: 120,
        dy: 0,
        jumpForce: 15,
        gravity: 1.0,
        groundY: 350,
        jumpCount: 0,
        isJumping: false
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
    function initObjects() {
        // –°–æ–∑–¥–∞–µ–º 2 —Å–µ—Ä–¥–µ—á–∫–∞
        for (let i = 0; i < 2; i++) {
            hearts.push({
                x: 300 + Math.random() * 300,
                y: 150 + Math.random() * 150,
                size: 50,
                collected: false,
                pulse: Math.random() * Math.PI * 2,
                speed: 2,
                rotation: 0
            });
        }
        
        // –°–æ–∑–¥–∞–µ–º 1 –∑–ª–æ–¥–µ—è
        for (let i = 0; i < 1; i++) {
            enemies.push({
                x: 500 + Math.random() * 200,
                y: 350,
                width: 60,
                height: 60,
                speed: 3,
                type: 0
            });
        }
    }
    
    initObjects();
    
    // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö —Å–µ—Ä–¥–µ—á–µ–∫
    function spawnHeart() {
        if (hearts.length < 3) {
            hearts.push({
                x: 850,
                y: 150 + Math.random() * 150,
                size: 50,
                collected: false,
                pulse: Math.random() * Math.PI * 2,
                speed: 2,
                rotation: 0
            });
        }
    }
    
    // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –∑–ª–æ–¥–µ–µ–≤
    function spawnEnemy() {
        if (enemies.length < 2) {
            enemies.push({
                x: 850,
                y: 350,
                width: 60,
                height: 60,
                speed: 3 + Math.random(),
                type: Math.floor(Math.random() * 2)
            });
        }
    }
    
    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–≥—Ä—ã
    function update() {
        if (gameOver) return;
        
        // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –∏ –ø—Ä—ã–∂–∫–∏
        player.dy += player.gravity;
        player.y += player.dy;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–º–ª–∏
        if (player.y > player.groundY) {
            player.y = player.groundY;
            player.dy = 0;
            player.jumpCount = 0;
            player.isJumping = false;
        } else {
            player.isJumping = true;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–¥–µ—á–µ–∫
        for (let i = hearts.length - 1; i >= 0; i--) {
            const heart = hearts[i];
            
            if (heart.collected) {
                hearts.splice(i, 1);
                continue;
            }
            
            heart.x -= gameSpeed + heart.speed;
            heart.pulse += 0.1;
            heart.rotation += 0.05;
            
            if (heart.x < -50) {
                hearts.splice(i, 1);
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∞ —Å–µ—Ä–¥–µ—á–∫–∞
            if (heart.x < player.x + player.width &&
                heart.x + heart.size > player.x &&
                heart.y < player.y + player.height &&
                heart.y + heart.size > player.y) {
                
                heart.collected = true;
                score++;
                document.getElementById("heartsCount").textContent = score;
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–±–æ—Ä–∞
                createCollectEffect(heart.x + heart.size/2, heart.y + heart.size/2);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã (–Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å 7 —Å–µ—Ä–¥–µ—á–µ–∫)
                if (score >= 7) {
                    winGame1();
                    return;
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–ª–æ–¥–µ–µ–≤
        for (let i = enemies.length - 1; i >= 0; i--) {
            const enemy = enemies[i];
            
            enemy.x -= enemy.speed;
            
            if (enemy.x < -100) {
                enemies.splice(i, 1);
                continue;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ –∑–ª–æ–¥–µ–µ–º
            if (enemy.x < player.x + player.width &&
                enemy.x + enemy.width > player.x &&
                enemy.y < player.y + player.height &&
                enemy.y + enemy.height > player.y) {
                
                lives--;
                document.getElementById("livesCount").textContent = lives;
                
                // –≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞
                createHitEffect();
                
                // –û—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                player.dy = -10;
                player.y -= 40;
                
                // –£–¥–∞–ª—è–µ–º –∑–ª–æ–¥–µ—è
                enemies.splice(i, 1);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
                if (lives <= 0) {
                    loseGame1();
                    return;
                }
            }
        }
        
        // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        if (frame % 90 === 0) spawnHeart();
        if (frame % 180 === 0) spawnEnemy();
        
        // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        if (frame % 600 === 0 && gameSpeed < 6) {
            gameSpeed += 0.3;
            document.getElementById("speedCount").textContent = gameSpeed.toFixed(1);
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        draw();
        
        frame++;
        requestAnimationFrame(update);
    }
    
    function draw() {
        // –û—á–∏—Å—Ç–∫–∞
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –§–æ–Ω —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#0a0a2a");
        gradient.addColorStop(0.5, "#1a1a3a");
        gradient.addColorStop(1, "#2a2a5a");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –ó–µ–º–ª—è
        ctx.fillStyle = "#3a2a4a";
        ctx.fillRect(0, 420, canvas.width, canvas.height - 420);
        
        // –¢—Ä–∞–≤–∞
        ctx.fillStyle = "#4a3a5a";
        for (let i = 0; i < canvas.width; i += 20) {
            ctx.fillRect(i, 420, 10, 5);
        }
        
        // –ò–ì–†–û–ö - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const currentPlayerImg = player.isJumping ? playerJumpImg : playerImg;
        ctx.drawImage(currentPlayerImg, player.x, player.y, player.width, player.height);
        
        // –°–ï–†–î–ï–ß–ö–ò
        hearts.forEach(heart => {
            if (!heart.collected) {
                const pulseSize = heart.size + Math.sin(heart.pulse) * 8;
                
                // –†–∏—Å—É–µ–º —Å–µ—Ä–¥–µ—á–∫–æ —Å –≤—Ä–∞—â–µ–Ω–∏–µ–º
                ctx.save();
                ctx.translate(heart.x + heart.size/2, heart.y + heart.size/2);
                ctx.rotate(heart.rotation);
                ctx.drawImage(heartImg, -pulseSize/2, -pulseSize/2, pulseSize, pulseSize);
                ctx.restore();
            }
        });
        
        // –ó–õ–û–î–ï–ò
        enemies.forEach(enemy => {
            if (enemyImg.complete && enemyImg.naturalWidth > 0) {
                ctx.drawImage(enemyImg, enemy.x, enemy.y, enemy.width, enemy.height);
            } else {
                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, —Ä–∏—Å—É–µ–º –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–ª–æ–¥–µ—è
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(
                    enemy.x + enemy.width/2,
                    enemy.y + enemy.height/2,
                    enemy.width/2,
                    0, Math.PI * 2
                );
                ctx.fill();
                
                // –ó–ª—ã–µ –≥–ª–∞–∑–∞
                ctx.fillStyle = '#000000';
                ctx.fillRect(enemy.x + 15, enemy.y + 15, 8, 10);
                ctx.fillRect(enemy.x + enemy.width - 23, enemy.y + 15, 8, 10);
                
                // –ó–ª–æ–π —Ä–æ—Ç
                ctx.fillRect(enemy.x + 20, enemy.y + enemy.height - 20, enemy.width - 40, 5);
            }
        });
        
        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px "Press Start 2P"';
        ctx.fillText('–°–æ–±–µ—Ä–∏ 7 —Å–µ—Ä–¥–µ—á–µ–∫!', 20, 30);
        
        // –°—á–µ—Ç—á–∏–∫–∏
        ctx.fillText(`‚ù§Ô∏è: ${score}/10`, 20, 60);
        ctx.fillText(`üíÄ: ${lives}`, 200, 60);
        ctx.fillText(`‚ö°: ${gameSpeed.toFixed(1)}`, 350, 60);
        
        // –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        ctx.fillStyle = '#4a4a6a';
        ctx.fillRect(20, 70, 200, 10);
        ctx.fillStyle = '#ff5f7d';
        ctx.fillRect(20, 70, (score / 7) * 200, 10);
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        ctx.fillStyle = '#ff9a9e';
        ctx.font = '12px "Press Start 2P"';
        ctx.fillText('–ü–†–û–ë–ï–õ - –ø—Ä—ã–∂–æ–∫ (–º–æ–∂–Ω–æ –¥–≤–∞–∂–¥—ã!)', 20, 480);
    }
    
    // –≠—Ñ—Ñ–µ–∫—Ç —Å–±–æ—Ä–∞ —Å–µ—Ä–¥–µ—á–∫–∞
    function createCollectEffect(x, y) {
        for (let i = 0; i < 4; i++) {
            setTimeout(() => {
                const angle = (i / 4) * Math.PI * 2;
                const distance = 20;
                const px = x + Math.cos(angle) * distance;
                const py = y + Math.sin(angle) * distance;
                
                ctx.fillStyle = i % 2 === 0 ? '#ff5f7d' : '#ff9a9e';
                ctx.beginPath();
                ctx.arc(px, py, 3, 0, Math.PI * 2);
                ctx.fill();
            }, i * 50);
        }
    }
    
    // –≠—Ñ—Ñ–µ–∫—Ç —É–¥–∞—Ä–∞
    function createHitEffect() {
        // –ö—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
        setTimeout(() => {
            ctx.fillStyle = 'rgba(255, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }, 50);
    }
    
    // –ü–æ–±–µ–¥–∞
    function winGame1() {
        gameOver = true;
        
        ctx.fillStyle = 'rgba(0, 255, 100, 0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#4CAF50';
        ctx.font = '40px "Press Start 2P"';
        ctx.fillText('–ü–û–ë–ï–î–ê!', 300, 200);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px "Press Start 2P"';
        ctx.fillText('–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ!', 200, 250);
        
        setTimeout(() => {
            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ —Å–æ–±—Ä–∞–Ω–Ω–æ–µ
            memories[currentMemoryIndex].collected = true;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Å—Ü–µ–Ω—É
            document.getElementById("miniGame1").style.display = "none";
            scene.style.display = "flex";
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            setBackground(memories[currentMemoryIndex].bg);
            memoryPhoto.src = "images/memory1.jpg";
            memoryPhoto.style.display = "block";
            
            typeTextHTML(textDiv, 
                '<p class="pulse-text">‚úÖ –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï –°–û–ë–†–ê–ù–û!</p>' +
                '<p>–¢—ã –≤—Å–ø–æ–º–Ω–∏–ª —Ç–æ—Ç –¥–æ–∂–¥—å –ø–æ–¥ –¥—É–±–æ–º...</p>' +
                '<p>–ï—ë —Å–º–µ—Ö —Å–º–µ—à–∏–≤–∞–ª—Å—è —Å–æ –∑–≤—É–∫–æ–º –∫–∞–ø–µ–ª—å,</p>' +
                '<p>–∞ –µ—ë –≥–ª–∞–∑–∞ —Å–∏—è–ª–∏ –∫–∞–∫ –∑–≤—ë–∑–¥—ã –≤ –¥–æ–∂–¥–ª–∏–≤—É—é –Ω–æ—á—å.</p>', 
                30, 
                () => {
                    nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
                }
            );
        }, 1500);
    }
    
    // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ
    function loseGame1() {
        gameOver = true;
        
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#ff5f7d';
        ctx.font = '40px "Press Start 2P"';
        ctx.fillText('–ü–û–†–ê–ñ–ï–ù–ò–ï', 280, 200);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px "Press Start 2P"';
        ctx.fillText('–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!', 250, 250);
        
        setTimeout(() => {
            document.getElementById("miniGame1").style.display = "none";
            scene.style.display = "flex";
            
            typeTextHTML(textDiv, 
                '<p>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ...</p>' +
                '<p>–ó–ª–æ–¥–µ–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å —Å–∏–ª—å–Ω–µ–µ.</p>' +
                '<p>–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞!</p>', 
                30, 
                () => {
                    nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
                }
            );
        }, 1500);
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function handleKeyDown(e) {
        if (e.code === 'Space' && player.jumpCount < 2 && !gameOver) {
            player.dy = -player.jumpForce;
            player.jumpCount++;
            player.isJumping = true;
        }
    }
    
    window.removeEventListener('keydown', handleKeyDown);
    window.addEventListener('keydown', handleKeyDown);
    
    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
    console.log("–ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞!");
    update();
}

function endGame1() {
    document.getElementById("miniGame1").style.display = "none";
    scene.style.display = "flex";
    showHub();
}

// ===============================
// –ú–ò–ù–ò-–ò–ì–†–ê 2: –õ–ê–ë–ò–†–ò–ù–¢ –°–û –ó–í–ï–ó–î–ê–ú–ò
// ===============================
function startMiniGame2() {
    scene.style.display = "none";
    document.getElementById("miniGame2").style.display = "flex";
    
    const canvas = document.getElementById("game2Canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 600;
    
    const maze = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,1,0,1,0,1,1,1,1,1,1,0,1,0,1],
        [1,0,1,0,0,0,0,0,0,0,0,1,0,1,0,1],
        [1,0,1,1,1,1,1,0,1,1,0,1,0,1,0,1],
        [1,0,0,0,0,0,1,0,1,0,0,1,0,1,0,1],
        [1,1,1,1,1,0,1,0,1,0,1,1,0,0,0,1],
        [1,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1],
        [1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];
    
    const cellSize = 50;
    let player = {x: 1, y: 1};
    let stars = [];
    let collectedStars = 0;
    let lives = 3;
    let timeLeft = 60;
    let gameOver = false;
    
    // –°–æ–∑–¥–∞–µ–º –∑–≤–µ–∑–¥—ã
    const starPositions = [
        [3,2], [7,1], [12,1], [14,3],
        [2,5], [10,4], [13,6], [5,8],
        [8,9], [14,9]
    ];
    
    starPositions.forEach(pos => {
        stars.push({
            x: pos[0],
            y: pos[1],
            collected: false,
            pulse: Math.random() * Math.PI * 2
        });
    });
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const keys = {};
    document.addEventListener("keydown", (e) => {
        keys[e.key.toLowerCase()] = true;
    });
    document.addEventListener("keyup", (e) => {
        keys[e.key.toLowerCase()] = false;
    });
    
    // –¢–∞–π–º–µ—Ä
    const timer = setInterval(() => {
        if (!gameOver) {
            timeLeft--;
            document.getElementById("timeCount").textContent = timeLeft;
            
            if (timeLeft <= 0) {
                loseGame2();
                clearInterval(timer);
            }
        }
    }, 1000);
    
    function updateGame2() {
        if (gameOver) return;
        
        // –î–≤–∏–∂–µ–Ω–∏–µ
        let newX = player.x;
        let newY = player.y;
        
        if (keys['w'] || keys['—Ü']) newY--;
        if (keys['s'] || keys['—ã']) newY++;
        if (keys['a'] || keys['—Ñ']) newX--;
        if (keys['d'] || keys['–≤']) newX++;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–Ω
        if (maze[newY] && maze[newY][newX] === 0) {
            player.x = newX;
            player.y = newY;
        }
        
        // –°–±–æ—Ä –∑–≤–µ–∑–¥
        stars.forEach(star => {
            if (!star.collected && 
                Math.abs(player.x - star.x) < 0.5 && 
                Math.abs(player.y - star.y) < 0.5) {
                star.collected = true;
                collectedStars++;
                document.getElementById("starsCount").textContent = collectedStars;
                
                if (collectedStars >= 10) {
                    winGame2();
                    clearInterval(timer);
                }
            }
        });
        
        drawGame2();
        requestAnimationFrame(updateGame2);
    }
    
    function drawGame2() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –§–æ–Ω
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#1a0a2a");
        gradient.addColorStop(1, "#3a1a5a");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –õ–∞–±–∏—Ä–∏–Ω—Ç
        for (let y = 0; y < maze.length; y++) {
            for (let x = 0; x < maze[y].length; x++) {
                if (maze[y][x] === 1) {
                    ctx.fillStyle = "#5a4a8a";
                    ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                    
                    // –¢–µ–∫—Å—Ç—É—Ä–∞ —Å—Ç–µ–Ω
                    ctx.fillStyle = "#4a3a7a";
                    ctx.fillRect(x * cellSize + 5, y * cellSize + 5, cellSize - 10, cellSize - 10);
                }
            }
        }
        
        // –ó–≤–µ–∑–¥—ã
        stars.forEach(star => {
            if (!star.collected) {
                star.pulse += 0.1;
                const size = 30 + Math.sin(star.pulse) * 5;
                
                const starImg = new Image();
                starImg.src = characterImages.star;
                ctx.save();
                ctx.translate(
                    star.x * cellSize + cellSize/2,
                    star.y * cellSize + cellSize/2
                );
                ctx.rotate(star.pulse * 0.5);
                ctx.drawImage(starImg, -size/2, -size/2, size, size);
                ctx.restore();
                
                // –°–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowColor = "#ffd700";
                ctx.shadowBlur = 15;
                ctx.drawImage(
                    starImg,
                    star.x * cellSize + cellSize/2 - size/2,
                    star.y * cellSize + cellSize/2 - size/2,
                    size, size
                );
                ctx.shadowBlur = 0;
            }
        });
        
        // –ò–≥—Ä–æ–∫
        const playerImg = new Image();
        playerImg.src = characterImages.player2;
        ctx.drawImage(
            playerImg,
            player.x * cellSize + 10,
            player.y * cellSize + 10,
            cellSize - 20, cellSize - 20
        );
        
        // –°–ª–µ–¥ –∏–≥—Ä–æ–∫–∞
        ctx.fillStyle = "rgba(255, 95, 125, 0.3)";
        ctx.beginPath();
        ctx.arc(
            player.x * cellSize + cellSize/2,
            player.y * cellSize + cellSize/2,
            15, 0, Math.PI * 2
        );
        ctx.fill();
        
        // –í—Ä–∞–≥–∏ (–¥–≤–∏–≥–∞—é—â–∏–µ—Å—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è)
        ctx.fillStyle = "#ff5f7d";
        const enemyX = 7 + Math.sin(Date.now() / 1000) * 3;
        const enemyY = 7 + Math.cos(Date.now() / 1000) * 2;
        
        const enemyImg = new Image();
        enemyImg.src = characterImages.enemy2;
        ctx.drawImage(
            enemyImg,
            enemyX * cellSize + 5,
            enemyY * cellSize + 5,
            cellSize - 10, cellSize - 10
        );
        
        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –≤—Ä–∞–≥–æ–º
        if (Math.abs(player.x - enemyX) < 0.5 && Math.abs(player.y - enemyY) < 0.5) {
            lives--;
            document.getElementById("lives2Count").textContent = lives;
            player.x = 1;
            player.y = 1;
            
            if (lives <= 0) {
                loseGame2();
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        ctx.fillStyle = "white";
        ctx.font = "16px 'Press Start 2P'";
        ctx.fillText("–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ü–µ—Ä–≤—ã–π –ø–æ—Ü–µ–ª—É–π", 20, 30);
    }
    
    function winGame2() {
        gameOver = true;
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#ffd700";
        ctx.font = "40px 'Press Start 2P'";
        ctx.fillText("–ü–û–ë–ï–î–ê!", 300, 250);
        
        setTimeout(() => {
            memories[currentMemoryIndex].collected = true;
            document.getElementById("miniGame2").style.display = "none";
            scene.style.display = "flex";
            
            setBackground(memories[currentMemoryIndex].bg);
            memoryPhoto.src = "images/memory2.jpg";
            memoryPhoto.style.display = "block";
            
            typeTextHTML(textDiv, "<p class='pulse-text'>‚úÖ –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï –°–û–ë–†–ê–ù–û!</p><p>–¢—ã –≤—Å–ø–æ–º–Ω–∏–ª —Ç–æ—Ç –ø–µ—Ä–≤—ã–π –ø–æ—Ü–µ–ª—É–π... –≤–∫—É—Å –∞–ª–∫–æ–≥–æ–ª—è, –±–∏–µ–Ω–∏–µ —Å–µ—Ä–¥—Ü–∞...</p>", 30, () => {
                nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
            });
        }, 1500);
    }
    
    function loseGame2() {
        gameOver = true;
        clearInterval(timer);
        
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#ff5f7d";
        ctx.font = "40px 'Press Start 2P'";
        ctx.fillText("–í–†–ï–ú–Ø –í–´–®–õ–û", 250, 250);
        
        setTimeout(() => {
            document.getElementById("miniGame2").style.display = "none";
            scene.style.display = "flex";
            
            typeTextHTML(textDiv, "<p>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–æ–≤—Ä–µ–º—è...</p>", 30, () => {
                nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
            });
        }, 2000);
    }
    
    updateGame2();
}

function endGame2() {
    document.getElementById("miniGame2").style.display = "none";
    scene.style.display = "flex";
    showHub();
}

// ===============================
// –ú–ò–ù–ò-–ò–ì–†–ê 3: –ë–ò–¢–í–ê –° –¢–ï–ù–¨–Æ
// ===============================
function startMiniGame3() {
    scene.style.display = "none";
    document.getElementById("miniGame3").style.display = "flex";

    // –ú–µ–Ω—è–µ–º –º—É–∑—ã–∫—É –Ω–∞ –±–æ–µ–≤—É—é
    music.pause();
    music.src = musicFiles.fight;
    music.play().catch(e => {
        console.log("–ë–æ–µ–≤–∞—è –º—É–∑—ã–∫–∞ –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è");
        const enableOnClick = () => {
            music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É"));
            document.removeEventListener('click', enableOnClick);
            document.removeEventListener('keydown', enableOnClick);
        };
        document.addEventListener('click', enableOnClick);
        document.addEventListener('keydown', enableOnClick);
    });

    const canvas = document.getElementById("game3Canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 600;
    
    let player = {
        x: 100,
        y: 300,
        width: 100,
        height: 150,
        health: 150,
        speed: 5,
        facingRight: true,
        lastMoveDirection: 'right',
        hasShield: true,
        shieldActive: false,
        shieldHealth: 50,
        shieldCooldown: 0,
        shieldDuration: 3000,
        shieldCooldownTime: 5000
    };
    
    let enemy = {
        x: 600,
        y: 300,
        width: 120,
        height: 180,
        health: 200,
        speed: 2
    };
    
    let bullets = [];
    let enemyBullets = [];
    let ammo = 30;
    let lastShot = 0;
    let reloading = false;
    let gameOver = false;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById("playerHealth").textContent = player.health;
    document.getElementById("enemyHealth").textContent = enemy.health;
    document.getElementById("ammoCount").textContent = ammo;
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const keys = {};
    
    function handleKeyDown(e) {
        keys[e.key.toLowerCase()] = true;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
        if (keys['a'] || keys['—Ñ']) player.lastMoveDirection = 'left';
        if (keys['d'] || keys['–≤']) player.lastMoveDirection = 'right';
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —â–∏—Ç–∞ (–∫–ª–∞–≤–∏—à–∞ E)
        if ((e.key.toLowerCase() === 'e' || e.key.toLowerCase() === '—É') && 
            player.hasShield && 
            !player.shieldActive && 
            player.shieldCooldown <= 0) {
            player.shieldActive = true;
            player.shieldCooldown = player.shieldCooldownTime;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —â–∏—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
                if (player.shieldActive) {
                    player.shieldActive = false;
                }
            }, player.shieldDuration);
        }
        
        // –°—Ç—Ä–µ–ª—å–±–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        if (e.code === "Space" && !reloading && ammo > 0 && Date.now() - lastShot > 200) {
            let bulletX, bulletY, bulletVx;
            
            if (player.lastMoveDirection === 'right') {
                bulletX = player.x + player.width;
                bulletVx = 10;
            } else {
                bulletX = player.x;
                bulletVx = -10;
            }
            
            bulletY = player.y + player.height/2;
            
            bullets.push({
                x: bulletX,
                y: bulletY,
                vx: bulletVx,
                vy: 0,
                direction: player.lastMoveDirection
            });
            
            ammo--;
            lastShot = Date.now();
            document.getElementById("ammoCount").textContent = ammo;
        }
        
        // –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞
        if (e.key.toLowerCase() === 'r' && !reloading) {
            reloading = true;
            setTimeout(() => {
                ammo = 30;
                reloading = false;
                document.getElementById("ammoCount").textContent = ammo;
            }, 2000);
        }
    }
    
    function handleKeyUp(e) {
        keys[e.key.toLowerCase()] = false;
    }
    
    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    window.addEventListener("keydown", handleKeyDown);
    window.addEventListener("keyup", handleKeyUp);
    
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–±–µ–¥—ã/–ø–æ—Ä–∞–∂–µ–Ω–∏—è
    function winGame3() {
        gameOver = true;
        
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#4CAF50";
        ctx.font = "40px 'Press Start 2P'";
        ctx.fillText("–¢–ï–ù–¨ –ü–û–ë–ï–ñ–î–ï–ù–ê", 200, 250);
        
        setTimeout(() => {
            memories[currentMemoryIndex].collected = true;
            document.getElementById("miniGame3").style.display = "none";
            
            const allCollected = memories.every(m => m.collected);
            if (allCollected) {
                music.pause();
                music.src = musicFiles.main;
                music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É"));
                showFinalKissScene();
            } else {
                scene.style.display = "flex";
                setBackground(memories[currentMemoryIndex].bg);
                memoryPhoto.src = "images/memory3.jpg";
                memoryPhoto.style.display = "block";
                
                music.pause();
                music.src = musicFiles.main;
                music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É"));
                
                typeTextHTML(textDiv, "<p class='pulse-text'>‚úÖ –í–û–°–ü–û–ú–ò–ù–ê–ù–ò–ï –°–û–ë–†–ê–ù–û!</p><p>–¢—ã –≤—Å–ø–æ–º–Ω–∏–ª, –∫–∞–∫ –≤—Å—ë –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å...</p>", 30, () => {
                    nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
                });
            }
        }, 2000);
    }
    
    function loseGame3() {
        gameOver = true;
        
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#ff5f7d";
        ctx.font = "40px 'Press Start 2P'";
        ctx.fillText("–í–´ –ü–†–û–ò–ì–†–ê–õ–ò", 250, 250);
        
        setTimeout(() => {
            document.getElementById("miniGame3").style.display = "none";
            scene.style.display = "flex";
            
            music.pause();
            music.src = musicFiles.main;
            music.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É"));
            
            typeTextHTML(textDiv, "<p>–¢–µ–Ω—å –æ–∫–∞–∑–∞–ª–∞—Å—å —Å–∏–ª—å–Ω–µ–µ...</p><p>–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!</p>", 30, () => {
                nextButton("–í–ï–†–ù–£–¢–¨–°–Ø –í –•–ê–ë", showHub);
            });
        }, 2000);
    }
    
    function updateGame3() {
        if (gameOver) {
            requestAnimationFrame(updateGame3);
            return;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏ —â–∏—Ç–∞
        if (player.shieldCooldown > 0) {
            player.shieldCooldown -= 16.67;
        }
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        if (keys['w'] || keys['—Ü']) player.y -= player.speed;
        if (keys['s'] || keys['—ã']) player.y += player.speed;
        if (keys['a'] || keys['—Ñ']) {
            player.x -= player.speed;
            player.lastMoveDirection = 'left';
        }
        if (keys['d'] || keys['–≤']) {
            player.x += player.speed;
            player.lastMoveDirection = 'right';
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
        player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–∞ (–ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
        const dx = player.x - enemy.x;
        const dy = player.y - enemy.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist > 0) {
            enemy.x += (dx / dist) * enemy.speed;
            enemy.y += (dy / dist) * enemy.speed;
        }
        
        // –í—ã—Å—Ç—Ä–µ–ª—ã –≤—Ä–∞–≥–∞
        if (Math.random() < 0.02 && enemyBullets.length < 3) {
            const angle = Math.atan2(
                player.y + player.height/2 - (enemy.y + enemy.height/2),
                player.x + player.width/2 - (enemy.x + enemy.width/2)
            );
            
            enemyBullets.push({
                x: enemy.x,
                y: enemy.y + enemy.height/2,
                vx: Math.cos(angle) * 6,
                vy: Math.sin(angle) * 6
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å –∏–≥—Ä–æ–∫–∞
        bullets = bullets.filter(bullet => {
            bullet.x += bullet.vx;
            
            if (bullet.x > enemy.x && bullet.x < enemy.x + enemy.width &&
                bullet.y > enemy.y && bullet.y < enemy.y + enemy.height) {
                enemy.health -= 10;
                document.getElementById("enemyHealth").textContent = enemy.health;
                
                if (enemy.health <= 0) {
                    winGame3();
                }
                return false;
            }
            
            return bullet.x > -50 && bullet.x < canvas.width + 50;
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—É–ª—å –≤—Ä–∞–≥–∞
        enemyBullets = enemyBullets.filter(bullet => {
            bullet.x += bullet.vx;
            bullet.y += bullet.vy;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –ø—É–ª–∏ —Å —â–∏—Ç–æ–º
            if (player.shieldActive && player.shieldHealth > 0) {
                let shieldX, shieldY, shieldWidth, shieldHeight;
                
                if (player.lastMoveDirection === 'right') {
                    shieldX = player.x + player.width - 10;
                    shieldY = player.y + 30;
                    shieldWidth = 25;
                    shieldHeight = 90;
                } else {
                    shieldX = player.x - 15;
                    shieldY = player.y + 30;
                    shieldWidth = 25;
                    shieldHeight = 90;
                }
                
                if (bullet.x > shieldX && bullet.x < shieldX + shieldWidth &&
                    bullet.y > shieldY && bullet.y < shieldY + shieldHeight) {
                    
                    player.shieldHealth -= 10;
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –ø—É–ª–∏
                    bullet.vx = -bullet.vx * 0.5;
                    bullet.vy = -bullet.vy * 0.5;
                    
                    if (player.shieldHealth <= 0) {
                        player.shieldActive = false;
                        player.hasShield = false;
                    }
                    
                    return true;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∏–≥—Ä–æ–∫–∞
            if (bullet.x > player.x && bullet.x < player.x + player.width &&
                bullet.y > player.y && bullet.y < player.y + player.height) {
                
                player.health -= 15;
                document.getElementById("playerHealth").textContent = player.health;
                
                if (player.health <= 0) {
                    loseGame3();
                }
                return false;
            }
            
            return bullet.x > -50 && bullet.x < canvas.width + 50;
        });
        
        drawGame3();
        requestAnimationFrame(updateGame3);
    }
    
    function drawGame3() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // –§–æ–Ω –±–∏—Ç–≤—ã
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, "#2a0a1a");
        gradient.addColorStop(1, "#5a1a3a");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã
        ctx.fillStyle = "#8a4a6a";
        ctx.fillRect(0, 450, canvas.width, 150);
        
        ctx.fillStyle = "#7a3a5a";
        for (let i = 0; i < 5; i++) {
            ctx.fillRect(150 * i, 300, 100, 30);
        }
        
        // –©–∏—Ç (–µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω)
        if (player.shieldActive && player.shieldHealth > 0) {
            let shieldX, shieldY, shieldWidth, shieldHeight;
            
            if (player.lastMoveDirection === 'right') {
                shieldX = player.x + player.width - 10;
                shieldY = player.y + 30;
                shieldWidth = 25;
                shieldHeight = 90;
            } else {
                shieldX = player.x - 15;
                shieldY = player.y + 30;
                shieldWidth = 25;
                shieldHeight = 90;
            }
            
            const shieldGradient = ctx.createLinearGradient(
                shieldX, shieldY, 
                shieldX + shieldWidth, shieldY + shieldHeight
            );
            
            if (player.shieldHealth > 25) {
                shieldGradient.addColorStop(0, "#00ffff");
                shieldGradient.addColorStop(1, "#0088ff");
            } else {
                shieldGradient.addColorStop(0, "#ff4444");
                shieldGradient.addColorStop(1, "#ff0000");
            }
            
            ctx.fillStyle = shieldGradient;
            ctx.globalAlpha = 0.7;
            ctx.fillRect(shieldX, shieldY, shieldWidth, shieldHeight);
            
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = 2;
            ctx.strokeRect(shieldX, shieldY, shieldWidth, shieldHeight);
            
            ctx.shadowColor = "#00ffff";
            ctx.shadowBlur = 15;
            ctx.strokeRect(shieldX, shieldY, shieldWidth, shieldHeight);
            ctx.shadowBlur = 0;
            
            ctx.globalAlpha = 1.0;
        }
        
        // –ò–≥—Ä–æ–∫
        const playerImg = new Image();
        playerImg.src = characterImages.player3;
        
        ctx.save();
        if (player.lastMoveDirection === 'left') {
            ctx.scale(-1, 1);
            ctx.drawImage(playerImg, -player.x - player.width, player.y, player.width, player.height);
        } else {
            ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
        }
        ctx.restore();
        
        // –í—Ä–∞–≥
        const enemyImg = new Image();
        enemyImg.src = characterImages.enemy3;
        ctx.drawImage(enemyImg, enemy.x, enemy.y, enemy.width, enemy.height);
        
        // –ü—É–ª—å—Å–∞—Ü–∏—è –≤—Ä–∞–≥–∞
        ctx.shadowColor = "#ff5f7d";
        ctx.shadowBlur = 20;
        ctx.drawImage(enemyImg, enemy.x, enemy.y, enemy.width, enemy.height);
        ctx.shadowBlur = 0;
        
        // –ü—É–ª–∏ –∏–≥—Ä–æ–∫–∞
        bullets.forEach(bullet => {
            const bulletImg = new Image();
            bulletImg.src = characterImages.bullet;
            
            ctx.save();
            if (bullet.direction === 'left') {
                ctx.scale(-1, 1);
                ctx.drawImage(bulletImg, -bullet.x - 30, bullet.y, 30, 15);
            } else {
                ctx.drawImage(bulletImg, bullet.x, bullet.y, 30, 15);
            }
            ctx.restore();
            
            ctx.shadowColor = "#00ffff";
            ctx.shadowBlur = 10;
            if (bullet.direction === 'left') {
                ctx.scale(-1, 1);
                ctx.drawImage(bulletImg, -bullet.x - 30, bullet.y, 30, 15);
                ctx.scale(-1, 1);
            } else {
                ctx.drawImage(bulletImg, bullet.x, bullet.y, 30, 15);
            }
            ctx.shadowBlur = 0;
        });
        
        // –ü—É–ª–∏ –≤—Ä–∞–≥–∞
        enemyBullets.forEach(bullet => {
            const bulletImg = new Image();
            bulletImg.src = characterImages.enemyBullet;
            ctx.drawImage(bulletImg, bullet.x, bullet.y, 30, 15);
            
            ctx.shadowColor = "#ff5f7d";
            ctx.shadowBlur = 10;
            ctx.drawImage(bulletImg, bullet.x, bullet.y, 30, 15);
            ctx.shadowBlur = 0;
        });
        
        // –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏
        if (reloading) {
            ctx.fillStyle = "rgba(255, 255, 0, 0.5)";
            ctx.fillRect(player.x, player.y - 30, 100, 20);
            ctx.fillStyle = "white";
            ctx.font = "12px 'Press Start 2P'";
            ctx.fillText("–ü–ï–†–ï–ó–ê–†–Ø–î–ö–ê", player.x, player.y - 15);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —â–∏—Ç–∞
        if (player.hasShield) {
            ctx.fillStyle = "rgba(0, 255, 255, 0.3)";
            ctx.fillRect(player.x, player.y - 60, 100, 20);
            ctx.fillStyle = "white";
            ctx.font = "10px 'Press Start 2P'";
            
            if (player.shieldActive) {
                ctx.fillText("–©–ò–¢: " + player.shieldHealth, player.x + 10, player.y - 45);
            } else if (player.shieldCooldown > 0) {
                const cooldownSec = Math.ceil(player.shieldCooldown / 1000);
                ctx.fillText("–©–ò–¢: " + cooldownSec + "—Å", player.x + 10, player.y - 45);
            } else {
                ctx.fillText("–©–ò–¢ –ì–û–¢–û–í", player.x + 10, player.y - 45);
            }
        }
        
        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        ctx.fillStyle = "#ff9a9e";
        ctx.font = "12px 'Press Start 2P'";
        ctx.fillText("A/D - –¥–≤–∏–∂–µ–Ω–∏–µ + –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª—å–±—ã", 20, 570);
        ctx.fillText("SPACE - —Å—Ç—Ä–µ–ª—å–±–∞ | R - –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ | E - —â–∏—Ç", 20, 590);
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        ctx.fillStyle = "white";
        ctx.font = "16px 'Press Start 2P'";
        ctx.fillText("–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ù–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏", 20, 30);
    }
    
    // –ó–ê–ü–£–°–ö–ê–ï–ú –ò–ì–†–£!
    updateGame3();
}

function endGame3() {
    document.getElementById("miniGame3").style.display = "none";
    scene.style.display = "flex";
    music.pause();
    music.src = musicFiles.main;
    music.play().catch(e => {
        console.log("–ú—É–∑—ã–∫–∞ –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è");
    });
    showHub();
}
// ===============================
// –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¶–ï–ù–ê –° –ü–†–û–ë–£–ñ–î–ï–ù–ò–ï–ú
// ===============================
function showFinalKissScene() {
    scene.style.display = "none";
    hub.style.display = "none";
    finalKissScene.style.display = "flex";
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const kissContainer = document.querySelector('.kiss-container');
    if (kissContainer) {
        kissContainer.innerHTML = '';
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    const container = document.createElement('div');
    container.className = 'kiss-container';
    container.style.cssText = `
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    `;
    
    // –§–æ–Ω
    const background = document.createElement('img');
    background.className = 'kiss-background';
    background.src = "images/backgrounds/kiss_bg.jpg";
    background.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.8;
        filter: blur(3px);
        z-index: 1;
    `;
    
    // –§–æ—Ç–æ –ø–æ—Ü–µ–ª—É—è
    const kissImage = document.createElement('img');
    kissImage.id = 'kissMainImage';
    kissImage.src = "images/characters/kiss.png";
    kissImage.alt = "–ü–æ—Ü–µ–ª—É–π";
    kissImage.style.cssText = `
        position: relative;
        width: 300px;
        height: 300px;
        object-fit: cover;
        border-radius: 20px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 50px rgba(255, 95, 125, 0.5);
        z-index: 2;
        transform: scale(0.1);
        opacity: 0;
        transition: all 6s ease-out;
    `;
    
    // –¢–µ–∫—Å—Ç
    const textDiv = document.createElement('div');
    textDiv.id = 'kissText';
    textDiv.style.cssText = `
        position: absolute;
        bottom: 100px;
        z-index: 3;
        color: white;
        font-size: 24px;
        text-shadow: 2px 2px 4px #000;
        text-align: center;
        background: rgba(0, 0, 0, 0.6);
        padding: 20px;
        border-radius: 10px;
        max-width: 80%;
        opacity: 0;
        transition: opacity 2s;
    `;
    
    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.appendChild(background);
    container.appendChild(kissImage);
    container.appendChild(textDiv);
    
    // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const existingContainer = document.querySelector('.kiss-container');
    if (existingContainer) {
        existingContainer.remove();
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
    const controlsDiv = document.querySelector('.game-controls');
    if (controlsDiv) {
        controlsDiv.innerHTML = '';
        const continueBtn = document.createElement('button');
        continueBtn.textContent = '–ü–†–û–°–ù–£–¢–¨–°–Ø...';
        continueBtn.onclick = showWakeUpScene;
        continueBtn.style.cssText = `
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(145deg, #6a11cb, #2575fc);
            border: 2px solid #fff;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: opacity 3s;
        `;
        controlsDiv.appendChild(continueBtn);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∑–∂–µ
        setTimeout(() => {
            continueBtn.style.opacity = '1';
        }, 10000);
    }
    
    finalKissScene.insertBefore(container, finalKissScene.firstChild);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    setTimeout(() => {
        // 1. –ü–æ—è–≤–ª–µ–Ω–∏–µ –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ
        kissImage.style.transform = 'scale(0.8)';
        kissImage.style.opacity = '1';
        kissImage.style.width = '600px';
        kissImage.style.height = '600px';
        kissImage.style.boxShadow = '0 0 60px rgba(255, 95, 125, 0.8)';
        
        // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            textDiv.style.opacity = '1';
            showKissMessages();
        }, 2000);
        
        // 3. –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
        createHeartEffects();
        
    }, 500);
    
    let messageIndex = 0;
    const messages = [
        "–í—Å–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ–±—Ä–∞–Ω—ã...",
        "–ï—ë –æ–±—Ä–∞–∑ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–µ–µ —Å –∫–∞–∂–¥—ã–º –º–≥–Ω–æ–≤–µ–Ω–∏–µ–º...",
        "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Ç–µ–ø–ª–æ –µ—ë —Ä—É–∫, –∫–∞–∫ —Ç–æ–≥–¥–∞...",
        "–ï—ë –∑–∞–ø–∞—Ö... –∑–≤—É–∫ –≥–æ–ª–æ—Å–∞... —É–ª—ã–±–∫–∞...",
        "–ò –≤–æ—Ç –æ–Ω–∞ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π, –Ω–∞—Å—Ç–æ—è—â–∞—è...",
        "–¢–≤–æ—è –ª—é–±–æ–≤—å –≤–µ—Ä–Ω—É–ª–∞ –µ—ë –∏–∑ —Ç—å–º—ã..."
    ];
    
    function showKissMessages() {
        if (messageIndex < messages.length) {
            typeTextHTML(textDiv, messages[messageIndex], 40, () => {
                messageIndex++;
                if (messageIndex < messages.length) {
                    setTimeout(() => {
                        textDiv.innerHTML = '';
                        setTimeout(() => {
                            showKissMessages();
                        }, 500);
                    }, 1500);
                } else {
                    // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    setTimeout(() => {
                        typeTextHTML(textDiv, 
                            "<p class='pulse-text' style='font-size: 28px; color: #ff9a9e;'> –¢–´ –°–ú–û–ì </p>", 
                            30
                        );
                    }, 1000);
                }
            });
        }
    }
    
    function createHeartEffects() {
        // –°–æ–∑–¥–∞–µ–º –ø–∞–¥–∞—é—â–∏–µ —Å–µ—Ä–¥–µ—á–∫–∏
        for (let i = 0; i < 20; i++) {
            setTimeout(() => {
                const heart = document.createElement('div');
                heart.innerHTML = '‚ù§Ô∏è';
                heart.style.cssText = `
                    position: fixed;
                    top: -50px;
                    left: ${Math.random() * 100}vw;
                    font-size: ${15 + Math.random() * 20}px;
                    color: #ff5f7d;
                    opacity: ${0.3 + Math.random() * 0.5};
                    z-index: 2;
                    pointer-events: none;
                    animation: fallHeart ${2 + Math.random() * 3}s linear forwards;
                `;
                
                document.body.appendChild(heart);
                
                // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    if (heart.parentNode) heart.remove();
                }, 5000);
                
            }, i * 300);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Å–µ—Ä–¥–µ—á–µ–∫
        if (!document.querySelector('#heart-styles')) {
            const style = document.createElement('style');
            style.id = 'heart-styles';
            style.textContent = `
                @keyframes fallHeart {
                    0% {
                        transform: translateY(0) rotate(0deg) scale(0.5);
                        opacity: 0;
                    }
                    10% {
                        opacity: 0.7;
                        transform: scale(0.8);
                    }
                    90% {
                        opacity: 0.7;
                    }
                    100% {
                        transform: translateY(100vh) rotate(360deg) scale(0.5);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }
}

// ===============================
// –°–¶–ï–ù–ê –ü–†–û–ë–£–ñ–î–ï–ù–ò–Ø
// ===============================
function showWakeUpScene() {
    finalKissScene.style.display = "none";
    wakeUpScene.style.display = "flex";
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
    wakeupText.innerHTML = '';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω
    const wakeupBg = document.querySelector('.wakeup-background');
    if (wakeupBg) {
        wakeupBg.src = "images/backgrounds/wakeup_bg.jpg";
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è
    let wakeupStep = 0;
    const wakeupMessages = [
        "–¢—ã –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –≥–ª–∞–∑–∞...",
        "–£—Ç—Ä–æ. –°–æ–ª–Ω–µ—á–Ω—ã–µ –ª—É—á–∏ –ø—Ä–æ–±–∏–≤–∞—é—Ç—Å—è —Å–∫–≤–æ–∑—å —à—Ç–æ—Ä—ã...",
        "–¢—ã –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—à—å –≥–æ–ª–æ–≤—É –Ω–∞ –±–æ–∫...",
        "–ò –≤–∏–¥–∏—à—å –µ—ë...",
        "–û–Ω–∞ —Å–ø–∏—Ç —Ä—è–¥–æ–º, —Ç–∏—Ö–æ –¥—ã—à–∞...",
        "–ï—ë —Ä—É–∫–∞ –ª–µ–∂–∏—Ç –Ω–∞ —Ç–≤–æ–µ–π –≥—Ä—É–¥–∏...",
        "–¢–≤–æ—ë —Å–µ—Ä–¥—Ü–µ –∑–∞–º–∏—Ä–∞–µ—Ç –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ...",
        "–ü–æ—Ç–æ–º –Ω–∞—á–∏–Ω–∞–µ—Ç –±–∏—Ç—å—Å—è —Å–∏–ª—å–Ω–µ–µ...",
        "–û–Ω–∞ –∑–¥–µ—Å—å. –û–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è.",
        "–¢—ã –Ω–µ–∂–Ω–æ –∫–∞—Å–∞–µ—à—å—Å—è –µ—ë —â–µ–∫–∏...",
        "–û–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è –≤–æ —Å–Ω–µ –∏ –ø—Ä–∏–∂–∏–º–∞–µ—Ç—Å—è –±–ª–∏–∂–µ...",
        "¬´–Ø –Ω–∞—à—ë–ª —Ç–µ–±—è...¬ª - —à–µ–ø—á–µ—à—å —Ç—ã.",
        "¬´–Ø –≤—Å–µ–≥–¥–∞ —Å —Ç–æ–±–æ–π, –õ—é–±–æ–≤—å...¬ª - –±—É–¥—Ç–æ —Å–ª—ã—à–∏—à—å –≤ –æ—Ç–≤–µ—Ç."
    ];
    
    function showNextWakeupMessage() {
        if (wakeupStep < wakeupMessages.length) {
            const p = document.createElement('p');
            wakeupText.appendChild(p);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è –Ω–æ–≤—ã—Ö –∞–±–∑–∞—Ü–µ–≤
            if (wakeupStep > 0) {
                p.style.marginTop = '15px';
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            p.style.opacity = '0';
            p.style.transform = 'translateY(20px)';
            p.style.transition = 'all 0.8s ease-out';
            
            typeTextElement(p, wakeupMessages[wakeupStep], 40, () => {
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∞–±–∑–∞—Ü–∞
                setTimeout(() => {
                    p.style.opacity = '1';
                    p.style.transform = 'translateY(0)';
                    
                    wakeupStep++;
                    if (wakeupStep < wakeupMessages.length) {
                        setTimeout(showNextWakeupMessage, 1500);
                    } else {
                        // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        setTimeout(() => {
                            const finalP = document.createElement('p');
                            finalP.className = 'pulse-text';
                            finalP.style.cssText = `
                                font-size: 28px;
                                color: #ff9a9e;
                                margin-top: 30px;
                                text-shadow: 0 0 10px #ff5f7d;
                            `;
                            wakeupText.appendChild(finalP);
                            typeTextElement(finalP, "–∏ –∂–∏–ª–∏ –æ–Ω–∏ –î–æ–ª–≥–æ –∏ –°—á–∞—Å—Ç–ª–∏–≤–æ ", 50);
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ"
                            setTimeout(() => {
                                const restartBtn = document.querySelector('#wakeUpScene .game-controls button');
                                if (restartBtn) {
                                    restartBtn.style.opacity = '1';
                                    restartBtn.style.transform = 'scale(1)';
                                    restartBtn.style.transition = 'all 0.5s ease-out';
                                }
                            }, 2000);
                        }, 1000);
                    }
                }, 300);
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—á–∞—Ç–∏ —Ç–µ–∫—Å—Ç–∞ –≤ —ç–ª–µ–º–µ–Ω—Ç
    function typeTextElement(element, text, speed, callback) {
        element.innerHTML = '';
        let index = 0;
        
        function typeChar() {
            if (index < text.length) {
                element.innerHTML += text.charAt(index);
                index++;
                setTimeout(typeChar, speed);
            } else if (callback) {
                callback();
            }
        }
        
        typeChar();
    }
    
    // –ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    setTimeout(showNextWakeupMessage, 1000);
}

// ===============================
// –ü–ï–†–ï–ó–ê–ü–£–°–ö –ò–ì–†–´
// ===============================
function restartGame() {
    // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    gameStarted = false;
    currentMemoryIndex = 0;
    
    memories.forEach(mem => {
        mem.collected = false;
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ü–µ–Ω—ã
    finalKissScene.style.display = "none";
    wakeUpScene.style.display = "none";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
    loadingScreen.style.display = "flex";
    loadingScreen.style.opacity = '1';
    loadingText.textContent = "–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ —Å–æ–Ω...";
    
    // –≠—Ñ—Ñ–µ–∫—Ç –∑–∞—Ç—É—Ö–∞–Ω–∏—è
    setTimeout(() => {
        loadingScreen.style.display = "none";
        scene.style.display = "flex";
        
        // –°–±—Ä–æ—Å –º—É–∑—ã–∫–∏
        music.pause();
        music.currentTime = 0;
        
        // –ó–∞–ø—É—Å–∫ –∑–∞–Ω–æ–≤–æ
        setBackground("start");
        typeTextHTML(textDiv, "<p class='pulse-text'>–ê –º–æ–∂–µ—Ç —ç—Ç–æ –≤—Å–µ —Å–æ–Ω?</p><p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å...</p>", 40, () => {
            nextButton("–ù–ê–ß–ê–¢–¨ –°–ù–û–í–ê", startGameWithMusic);
        });
    }, 1500);
}

// ===============================
// –ó–ê–ü–£–°–ö –ò–ì–†–´ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
// ===============================
window.onload = init;
</script>
</body>
</html>